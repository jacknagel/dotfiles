#!/bin/sh
set -eu

seconds=3600
profile=

if [ $# -eq 0 ] && [ -n "${AWS_PROFILE-}" ]; then
  profile=$AWS_PROFILE
elif [ $# -eq 1 ] && aws-vault list --profiles | grep -q -F --line-regexp "$1"; then
  profile=$1
else
  profile=$(aws-vault list --profiles | fzy --query="$*")
fi

sleep "$seconds" && printf "\naws-vault session expired\n" &
aws-vault exec --duration="${seconds}s" "$profile"
kill -- -$$ 2>/dev/null
